# Start from a Python image
FROM python:3.11-slim

# Install dependencies needed to build the TPC-H tool
RUN apt-get update && \
    apt-get install -y build-essential unzip make gcc && \
    rm -rf /var/lib/apt/lists/*

# Set the working directory
WORKDIR /app

# Copy the manually downloaded zip file from your local machine
COPY tpch.zip .

# Unzip the tools and compile the dbgen data generator
RUN unzip tpch.zip && \
    # The zip file creates a directory with spaces, e.g., "TPC-H V3.0.1"
    # We rename it to something simple and predictable without spaces.
    mv "TPC-H V"* tpch-tools && \
    # Now we can safely cd into the new directory
    cd tpch-tools/dbgen && \
    # Copy the makefile template to create a new makefile
    cp makefile.suite makefile && \
    # Modify the makefile for PostgreSQL and Linux
    sed -i 's/DATABASE = DB2/DATABASE = POSTGRESQL/' makefile && \
    sed -i 's/MACHINE  = LINUX/MACHINE  = LINUX/' makefile && \
    # Compile the dbgen tool
    make

# Copy your local Python scripts into the container
COPY populate_db.py .
COPY profiler.py .

# Install Python dependencies for your script
RUN pip install psycopg2-binary python-dotenv

# The command that will run when this container starts
# 1. Generate data files using the new, predictable path.
# 2. Run your Python script to load them into the database.
CMD ["sh", "-c", "./tpch-tools/dbgen/dbgen -s 1 && python populate_db.py"]
